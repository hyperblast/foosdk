#!/bin/bash

set -e

script_dir="$(dirname $(readlink -f $0))"

function write_prologue()
{
    echo "# Generated by $(basename $0)" >> "$out_file"
}

function write_list()
{
    ignore_rules=$2

    if [ -z "$ignore_rules" ]; then
        ignore_rules='$^'
    fi

    (
        printf '\nset(\n    %s\n' "$1"
        LC_ALL=C sort | grep -viE "$ignore_rules" | xargs -n1 --no-run-if-empty printf '    %s\n'
        printf ')\n'
    ) >> "$out_file"
}

function dump_headers()
{
    ls $2/*.h | write_list "$1" "$3"
}

function dump_vcxproj()
{
    "$script_dir/dump-vcxproj.sh" "$2" | write_list "$1" "$3"
}

function dump_sdk_windows()
{
    out_file="cmake/SourcesWindows.cmake"
    rm -f $out_file || true

    write_prologue

    dump_headers WTL_HEADERS wtl/Include
    dump_headers SHARED_HEADERS sdk/foobar2000/shared

    dump_headers PFC_HEADERS sdk/pfc '(pfc-fb2k-hooks\.h)|(nix-objects\.h)'
    dump_vcxproj PFC_SOURCES sdk/pfc/pfc.vcxproj '(stdafx\.cpp)|(pfc-fb2k-hooks\.cpp)|(nix-objects\.cpp)'

    dump_headers SDK_HEADERS sdk/foobar2000/SDK
    dump_vcxproj SDK_SOURCES sdk/foobar2000/SDK/foobar2000_SDK.vcxproj

    dump_headers SDK_HELPERS_HEADERS sdk/foobar2000/helpers
    dump_vcxproj SDK_HELPERS_SOURCES sdk/foobar2000/helpers/foobar2000_sdk_helpers.vcxproj \
        '(stdafx\.cpp)|(TypeFind\.h)'

    dump_headers PPUI_HEADERS sdk/libPPUI
    dump_vcxproj PPUI_SOURCES sdk/libPPUI/libPPUI.vcxproj

    dump_vcxproj COMPONENT_CLIENT_SOURCES \
        sdk/foobar2000/foobar2000_component_client/foobar2000_component_client.vcxproj

    dump_headers SAMPLE_HEADERS sdk/foobar2000/foo_sample '(stdafx\.h)'
    dump_vcxproj SAMPLE_SOURCES sdk/foobar2000/foo_sample/foo_sample.vcxproj '(PCH\.cpp)'
}

cd "$script_dir/.."

dump_sdk_windows
